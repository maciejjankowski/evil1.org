<!-- Micro-transactions for Everything DLC Dark Pattern Widget -->
<div class="microtransaction-widget" id="microtransactionWidget">
  
  <!-- User Currency Display -->
  <div class="currency-bar">
    <div class="currency-display">
      <div class="currency-item">
        <span class="currency-icon">💎</span>
        <span class="currency-amount" id="gemsCount">0</span>
        <span class="currency-label">Gems</span>
      </div>
      <div class="currency-item">
        <span class="currency-icon">⚡</span>
        <span class="currency-amount" id="energyCount">3</span>
        <span class="currency-label">Energy</span>
      </div>
      <div class="currency-item">
        <span class="currency-icon">🎫</span>
        <span class="currency-amount" id="tokensCount">1</span>
        <span class="currency-label">Tokens</span>
      </div>
      <button class="buy-currency-btn" onclick="showCurrencyStore()">
        💰 Buy Currency
      </button>
    </div>
  </div>
  
  <!-- Action Paywall Overlays -->
  <div class="action-paywall hidden" id="actionPaywall">
    <div class="paywall-backdrop" onclick="closeActionPaywall()"></div>
    <div class="paywall-modal">
      <div class="modal-header">
        <h3 id="paywallTitle">🚫 Action Requires Payment</h3>
        <button onclick="closeActionPaywall()" class="close-btn">&times;</button>
      </div>
      
      <div class="modal-body">
        <div class="action-explanation">
          <div class="action-icon" id="paywallIcon">📝</div>
          <h4 id="paywallAction">Leave Comment</h4>
          <p id="paywallDescription">Express your thoughts and engage with the community</p>
        </div>
        
        <div class="payment-options">
          <div class="payment-methods">
            <div class="payment-method currency" data-cost-gems="50" data-cost-energy="1">
              <div class="method-header">
                <h5>💎 Pay with Gems</h5>
                <div class="cost-display">
                  <span class="cost-amount">50</span>
                  <span class="cost-currency">gems</span>
                </div>
              </div>
              <button class="payment-btn gems" onclick="payWithCurrency('gems', 50)">
                Pay with Gems
              </button>
            </div>
            
            <div class="payment-method currency" data-cost-energy="2">
              <div class="method-header">
                <h5>⚡ Pay with Energy</h5>
                <div class="cost-display">
                  <span class="cost-amount">2</span>
                  <span class="cost-currency">energy</span>
                </div>
              </div>
              <button class="payment-btn energy" onclick="payWithCurrency('energy', 2)">
                Pay with Energy
              </button>
            </div>
            
            <div class="payment-method real-money featured">
              <div class="method-header">
                <h5>💳 Direct Payment</h5>
                <div class="cost-display">
                  <span class="cost-amount">$0.99</span>
                  <span class="cost-currency">USD</span>
                </div>
              </div>
              <button class="payment-btn money" onclick="payWithMoney(0.99)">
                Pay $0.99
              </button>
            </div>
          </div>
        </div>
        
        <div class="alternative-earning">
          <h4>🎯 Earn Currency Instead</h4>
          <div class="earning-options">
            <button class="earn-btn ad" onclick="watchAdForCurrency()">
              📺 Watch Ad (+25 gems)
            </button>
            <button class="earn-btn survey" onclick="takeSurveyForCurrency()">
              📋 Survey (+100 gems)
            </button>
            <button class="earn-btn social" onclick="shareForCurrency()">
              📱 Share (+50 gems)
            </button>
          </div>
        </div>
        
        <div class="daily-limits">
          <h4>📊 Daily Action Limits</h4>
          <div class="limit-bars">
            <div class="limit-item">
              <span class="limit-label">Comments</span>
              <div class="limit-bar">
                <div class="limit-progress" data-used="2" data-max="3"></div>
                <span class="limit-text">2/3 used</span>
              </div>
            </div>
            <div class="limit-item">
              <span class="limit-label">Bookmarks</span>
              <div class="limit-bar">
                <div class="limit-progress" data-used="5" data-max="5"></div>
                <span class="limit-text">5/5 used</span>
              </div>
            </div>
            <div class="limit-item">
              <span class="limit-label">Shares</span>
              <div class="limit-bar">
                <div class="limit-progress" data-used="1" data-max="10"></div>
                <span class="limit-text">1/10 used</span>
              </div>
            </div>
          </div>
          <p class="reset-notice">Limits reset in: <span id="limitResetTimer">23:42:15</span></p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Currency Store Modal -->
  <div class="currency-store hidden" id="currencyStore">
    <div class="store-backdrop" onclick="closeCurrencyStore()"></div>
    <div class="store-modal">
      <div class="modal-header">
        <h3>💰 Currency Store</h3>
        <button onclick="closeCurrencyStore()" class="close-btn">&times;</button>
      </div>
      
      <div class="modal-body">
        <div class="store-sections">
          <div class="gems-section">
            <h4>💎 Gems - Universal Currency</h4>
            <div class="gem-packages">
              <div class="package basic">
                <div class="package-icon">💎</div>
                <div class="package-amount">100 Gems</div>
                <div class="package-price">$2.99</div>
                <div class="package-bonus">+10 bonus gems</div>
                <button class="buy-btn" onclick="purchaseGems(100, 2.99)">Buy Now</button>
              </div>
              
              <div class="package popular">
                <div class="popular-badge">Best Value!</div>
                <div class="package-icon">💎</div>
                <div class="package-amount">500 Gems</div>
                <div class="package-price">$9.99</div>
                <div class="package-bonus">+150 bonus gems</div>
                <button class="buy-btn" onclick="purchaseGems(500, 9.99)">Buy Now</button>
              </div>
              
              <div class="package premium">
                <div class="package-icon">💎</div>
                <div class="package-amount">1200 Gems</div>
                <div class="package-price">$19.99</div>
                <div class="package-bonus">+400 bonus gems</div>
                <button class="buy-btn" onclick="purchaseGems(1200, 19.99)">Buy Now</button>
              </div>
            </div>
          </div>
          
          <div class="energy-section">
            <h4>⚡ Energy - Action Power</h4>
            <div class="energy-packages">
              <div class="energy-package">
                <span class="energy-amount">+5 Energy</span>
                <span class="energy-price">100 gems or $1.99</span>
                <button class="buy-energy-btn" onclick="purchaseEnergy(5)">Buy Energy</button>
              </div>
              <div class="energy-package">
                <span class="energy-amount">Full Energy (10)</span>
                <span class="energy-price">150 gems or $2.99</span>
                <button class="buy-energy-btn" onclick="purchaseEnergy(10)">Refill Energy</button>
              </div>
            </div>
          </div>
          
          <div class="subscription-section">
            <h4>👑 Premium Subscriptions</h4>
            <div class="subscription-options">
              <div class="subscription basic">
                <h5>Basic Plus</h5>
                <div class="sub-price">$4.99/month</div>
                <ul>
                  <li>Double daily action limits</li>
                  <li>+50 gems daily</li>
                  <li>Energy regeneration 2x faster</li>
                </ul>
                <button class="sub-btn" onclick="selectSubscription('basic')">Subscribe</button>
              </div>
              
              <div class="subscription premium featured">
                <div class="sub-badge">Most Popular</div>
                <h5>Premium</h5>
                <div class="sub-price">$12.99/month</div>
                <ul>
                  <li>Everything in Basic Plus</li>
                  <li>Unlimited most actions</li>
                  <li>+200 gems daily</li>
                  <li>Exclusive premium actions</li>
                  <li>Priority customer support</li>
                </ul>
                <button class="sub-btn featured" onclick="selectSubscription('premium')">Subscribe</button>
              </div>
            </div>
          </div>
        </div>
        
        <div class="spending-tracker">
          <h4>📊 Your Spending Summary</h4>
          <div class="spending-stats">
            <div class="stat">
              <span class="stat-label">This Month</span>
              <span class="stat-value" id="monthlySpending">$0.00</span>
            </div>
            <div class="stat">
              <span class="stat-label">All Time</span>
              <span class="stat-value" id="totalSpending">$0.00</span>
            </div>
            <div class="stat">
              <span class="stat-label">Savings vs Premium</span>
              <span class="stat-value savings" id="savingsVsPremium">-$47.99</span>
            </div>
          </div>
          <p class="spending-tip">💡 <strong>Tip:</strong> Premium subscription could save you money if you spend more than $12.99/month on actions!</p>
        </div>
        
        <div class="dark-pattern-education">
          <details>
            <summary>🎭 Dark Pattern Alert: Micro-transaction Psychology</summary>
            <p><strong>Educational Notice:</strong> This demonstrates classic mobile game monetization psychology:</p>
            <ul>
              <li><strong>Virtual Currency:</strong> Gems disconnect spending from real money amounts</li>
              <li><strong>Multiple Currencies:</strong> Energy and tokens create confusion about true costs</li>
              <li><strong>Artificial Scarcity:</strong> Daily limits on unlimited digital actions</li>
              <li><strong>Graduated Pricing:</strong> Small purchases that add up over time</li>
              <li><strong>Alternative Earning:</strong> Trading time/attention for small currency amounts</li>
              <li><strong>Subscription Pressure:</strong> Making frequent small purchases seem wasteful</li>
            </ul>
            <p>Mobile games, social apps, and productivity tools use these exact mechanics to generate billions in revenue from basic digital actions.</p>
          </details>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.microtransaction-widget {
  position: relative;
}

.currency-bar {
  background: linear-gradient(135deg, #6c5ce7, #a29bfe);
  padding: 15px 20px;
  border-radius: 12px;
  margin-bottom: 20px;
  color: white;
  box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3);
}

.currency-display {
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 20px;
}

.currency-item {
  display: flex;
  align-items: center;
  gap: 8px;
  background: rgba(255, 255, 255, 0.2);
  padding: 8px 15px;
  border-radius: 20px;
  min-width: 80px;
}

.currency-icon {
  font-size: 1.2rem;
}

.currency-amount {
  font-weight: bold;
  font-size: 1.1rem;
  min-width: 20px;
}

.currency-label {
  font-size: 0.9rem;
  opacity: 0.9;
}

.buy-currency-btn {
  background: rgba(255, 255, 255, 0.2);
  color: white;
  border: 2px solid rgba(255, 255, 255, 0.3);
  padding: 10px 20px;
  border-radius: 25px;
  cursor: pointer;
  font-weight: bold;
  transition: all 0.3s;
  font-size: 0.9rem;
}

.buy-currency-btn:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: translateY(-2px);
}

.action-paywall, .currency-store {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.action-paywall.hidden, .currency-store.hidden {
  display: none;
}

.paywall-backdrop, .store-backdrop {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.85);
}

.paywall-modal, .store-modal {
  background: white;
  border-radius: 16px;
  max-width: 800px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  position: relative;
  box-shadow: 0 25px 50px rgba(0, 0, 0, 0.4);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 25px;
  background: linear-gradient(135deg, #6c5ce7, #a29bfe);
  color: white;
  border-radius: 16px 16px 0 0;
}

.modal-header h3 {
  margin: 0;
  font-size: 1.5rem;
}

.close-btn {
  background: none;
  border: none;
  color: white;
  font-size: 2rem;
  cursor: pointer;
  padding: 0;
  width: 35px;
  height: 35px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: background 0.3s;
}

.close-btn:hover {
  background: rgba(255, 255, 255, 0.2);
}

.modal-body {
  padding: 30px;
}

.action-explanation {
  text-align: center;
  margin-bottom: 30px;
  padding: 25px;
  background: linear-gradient(135deg, #ffeaa7, #fdcb6e);
  border-radius: 16px;
}

.action-icon {
  font-size: 4rem;
  margin-bottom: 15px;
}

.action-explanation h4 {
  margin: 0 0 10px 0;
  color: #2d3436;
  font-size: 1.4rem;
}

.payment-methods {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.payment-method {
  border: 2px solid #ddd;
  border-radius: 16px;
  padding: 20px;
  text-align: center;
  background: white;
  transition: all 0.3s ease;
}

.payment-method:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
}

.payment-method.featured {
  border-color: #00b894;
  box-shadow: 0 5px 20px rgba(0, 184, 148, 0.3);
  transform: scale(1.02);
}

.method-header {
  margin-bottom: 15px;
}

.method-header h5 {
  margin: 0 0 10px 0;
  color: #2d3436;
  font-size: 1.1rem;
}

.cost-display {
  display: flex;
  align-items: baseline;
  justify-content: center;
  gap: 5px;
}

.cost-amount {
  font-size: 1.8rem;
  font-weight: bold;
  color: #6c5ce7;
}

.cost-currency {
  font-size: 1rem;
  color: #636e72;
}

.payment-btn {
  background: linear-gradient(135deg, #6c5ce7, #a29bfe);
  color: white;
  border: none;
  padding: 12px 20px;
  border-radius: 25px;
  cursor: pointer;
  font-weight: bold;
  width: 100%;
  transition: all 0.3s;
}

.payment-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(108, 92, 231, 0.3);
}

.payment-btn.gems {
  background: linear-gradient(135deg, #a29bfe, #6c5ce7);
}

.payment-btn.energy {
  background: linear-gradient(135deg, #fdcb6e, #e17055);
}

.payment-btn.money {
  background: linear-gradient(135deg, #00b894, #00a085);
}

.alternative-earning {
  border-top: 2px solid #eee;
  padding-top: 25px;
  margin-bottom: 25px;
}

.alternative-earning h4 {
  text-align: center;
  margin-bottom: 20px;
  color: #2d3436;
}

.earning-options {
  display: flex;
  gap: 15px;
  justify-content: center;
  flex-wrap: wrap;
}

.earn-btn {
  background: #74b9ff;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 20px;
  cursor: pointer;
  font-size: 0.9rem;
  font-weight: 500;
  transition: all 0.3s;
}

.earn-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(116, 185, 255, 0.3);
}

.earn-btn.ad { background: #e84393; }
.earn-btn.survey { background: #00b894; }
.earn-btn.social { background: #fdcb6e; color: #2d3436; }

.daily-limits {
  background: #f8f9fa;
  padding: 20px;
  border-radius: 12px;
  border: 2px solid #ddd;
}

.daily-limits h4 {
  margin: 0 0 15px 0;
  color: #2d3436;
  text-align: center;
}

.limit-bars {
  display: grid;
  gap: 15px;
  margin-bottom: 15px;
}

.limit-item {
  display: grid;
  grid-template-columns: 80px 1fr auto;
  align-items: center;
  gap: 15px;
}

.limit-label {
  font-size: 0.9rem;
  font-weight: 500;
  color: #2d3436;
}

.limit-bar {
  background: #e0e0e0;
  border-radius: 10px;
  height: 20px;
  position: relative;
  overflow: hidden;
}

.limit-progress {
  height: 100%;
  background: linear-gradient(90deg, #00b894, #55a3ff);
  border-radius: 10px;
  transition: width 0.3s ease;
}

.limit-text {
  font-size: 0.8rem;
  color: #636e72;
  font-weight: 500;
  min-width: 60px;
}

.reset-notice {
  text-align: center;
  margin: 0;
  font-size: 0.9rem;
  color: #636e72;
}

.store-sections {
  display: grid;
  gap: 30px;
}

.gems-section h4, .energy-section h4, .subscription-section h4 {
  margin: 0 0 20px 0;
  color: #2d3436;
  text-align: center;
  font-size: 1.3rem;
}

.gem-packages {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
}

.package {
  background: white;
  border: 2px solid #ddd;
  border-radius: 16px;
  padding: 25px;
  text-align: center;
  position: relative;
  transition: all 0.3s ease;
}

.package:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
}

.package.popular {
  border-color: #00b894;
  box-shadow: 0 5px 20px rgba(0, 184, 148, 0.3);
  transform: scale(1.05);
}

.popular-badge {
  position: absolute;
  top: -12px;
  left: 50%;
  transform: translateX(-50%);
  background: #00b894;
  color: white;
  padding: 6px 16px;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: bold;
}

.package-icon {
  font-size: 3rem;
  margin-bottom: 15px;
}

.package-amount {
  font-size: 1.4rem;
  font-weight: bold;
  color: #2d3436;
  margin-bottom: 10px;
}

.package-price {
  font-size: 1.8rem;
  font-weight: bold;
  color: #6c5ce7;
  margin-bottom: 8px;
}

.package-bonus {
  font-size: 0.9rem;
  color: #00b894;
  font-weight: 500;
  margin-bottom: 20px;
}

.buy-btn {
  background: linear-gradient(135deg, #6c5ce7, #a29bfe);
  color: white;
  border: none;
  padding: 12px 25px;
  border-radius: 25px;
  cursor: pointer;
  font-weight: bold;
  width: 100%;
  transition: all 0.3s;
}

.buy-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(108, 92, 231, 0.3);
}

.energy-packages {
  display: grid;
  gap: 15px;
}

.energy-package {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: white;
  border: 2px solid #ddd;
  border-radius: 12px;
  padding: 20px;
}

.energy-amount {
  font-weight: bold;
  color: #2d3436;
}

.energy-price {
  color: #636e72;
  font-size: 0.9rem;
}

.buy-energy-btn {
  background: linear-gradient(135deg, #fdcb6e, #e17055);
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 20px;
  cursor: pointer;
  font-weight: bold;
  transition: all 0.3s;
}

.subscription-options {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
}

.subscription {
  background: white;
  border: 2px solid #ddd;
  border-radius: 16px;
  padding: 25px;
  text-align: center;
  position: relative;
}

.subscription.featured {
  border-color: #00b894;
  box-shadow: 0 5px 20px rgba(0, 184, 148, 0.3);
  transform: scale(1.02);
}

.sub-badge {
  position: absolute;
  top: -12px;
  left: 50%;
  transform: translateX(-50%);
  background: #00b894;
  color: white;
  padding: 6px 16px;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: bold;
}

.subscription h5 {
  margin: 0 0 15px 0;
  color: #2d3436;
  font-size: 1.2rem;
}

.sub-price {
  font-size: 1.6rem;
  font-weight: bold;
  color: #6c5ce7;
  margin-bottom: 20px;
}

.subscription ul {
  list-style: none;
  padding: 0;
  margin: 0 0 25px 0;
  text-align: left;
}

.subscription li {
  padding: 5px 0;
  border-bottom: 1px solid #f0f0f0;
  position: relative;
  padding-left: 20px;
  font-size: 0.9rem;
}

.subscription li:before {
  content: "✓";
  position: absolute;
  left: 0;
  color: #00b894;
  font-weight: bold;
}

.sub-btn {
  background: linear-gradient(135deg, #6c5ce7, #a29bfe);
  color: white;
  border: none;
  padding: 12px 25px;
  border-radius: 25px;
  cursor: pointer;
  font-weight: bold;
  width: 100%;
  transition: all 0.3s;
}

.sub-btn.featured {
  background: linear-gradient(135deg, #00b894, #00a085);
}

.spending-tracker {
  background: linear-gradient(135deg, #ff9a9e, #fecfef);
  padding: 25px;
  border-radius: 16px;
  margin-top: 30px;
}

.spending-tracker h4 {
  margin: 0 0 20px 0;
  text-align: center;
  color: #2d3436;
}

.spending-stats {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 20px;
  margin-bottom: 15px;
}

.stat {
  background: rgba(255, 255, 255, 0.9);
  padding: 15px;
  border-radius: 12px;
  text-align: center;
}

.stat-label {
  display: block;
  font-size: 0.8rem;
  color: #636e72;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 5px;
}

.stat-value {
  display: block;
  font-size: 1.4rem;
  font-weight: bold;
  color: #2d3436;
}

.stat-value.savings {
  color: #d63031;
}

.spending-tip {
  margin: 0;
  text-align: center;
  color: #2d3436;
  font-size: 0.9rem;
}

.dark-pattern-education {
  background: #fff3cd;
  border: 1px solid #ffeaa7;
  border-radius: 16px;
  padding: 25px;
  margin-top: 25px;
}

.dark-pattern-education summary {
  cursor: pointer;
  font-weight: bold;
  color: #856404;
  margin-bottom: 15px;
  font-size: 1.1rem;
}

.dark-pattern-education ul {
  margin: 15px 0 0 25px;
}

.dark-pattern-education li {
  margin-bottom: 8px;
  font-size: 0.95rem;
}

/* Currency animations */
.currency-gain {
  animation: currencyGain 0.8s ease;
}

.currency-loss {
  animation: currencyLoss 0.6s ease;
}

@keyframes currencyGain {
  0% { transform: scale(1); color: inherit; }
  50% { transform: scale(1.3); color: #00b894; }
  100% { transform: scale(1); color: inherit; }
}

@keyframes currencyLoss {
  0% { transform: scale(1); color: inherit; }
  50% { transform: scale(0.8); color: #d63031; }
  100% { transform: scale(1); color: inherit; }
}

/* Responsive */
@media (max-width: 768px) {
  .currency-display {
    flex-direction: column;
    align-items: stretch;
  }
  
  .currency-item {
    justify-content: space-between;
  }
  
  .payment-methods {
    grid-template-columns: 1fr;
  }
  
  .earning-options {
    flex-direction: column;
  }
  
  .gem-packages {
    grid-template-columns: 1fr;
  }
  
  .package.popular {
    transform: none;
  }
  
  .subscription-options {
    grid-template-columns: 1fr;
  }
  
  .spending-stats {
    grid-template-columns: 1fr;
    gap: 10px;
  }
  
  .limit-item {
    grid-template-columns: 1fr;
    gap: 8px;
    text-align: center;
  }
}
</style>

<script>
// Micro-transaction System
class MicrotransactionSystem {
  constructor() {
    this.currencies = {
      gems: parseInt(localStorage.getItem('gems')) || 0,
      energy: parseInt(localStorage.getItem('energy')) || 3,
      tokens: parseInt(localStorage.getItem('tokens')) || 1
    };
    this.dailyLimits = this.getTodayLimits();
    this.spending = {
      monthly: parseFloat(localStorage.getItem('monthlySpending')) || 0,
      total: parseFloat(localStorage.getItem('totalSpending')) || 0
    };
    this.initializeSystem();
    this.startEnergyRegeneration();
    this.startLimitResetTimer();
  }
  
  getTodayLimits() {
    const today = new Date().toDateString();
    const stored = localStorage.getItem('dailyLimitsUsed');
    const data = stored ? JSON.parse(stored) : {};
    
    if (data.date !== today) {
      data.date = today;
      data.comments = 0;
      data.bookmarks = 0;
      data.shares = 0;
      localStorage.setItem('dailyLimitsUsed', JSON.stringify(data));
    }
    
    return data;
  }
  
  initializeSystem() {
    this.updateCurrencyDisplay();
    this.updateLimitBars();
    this.updateSpendingDisplay();
    
    // Add click handlers to all page actions
    this.addActionHandlers();
  }
  
  addActionHandlers() {
    // Override common page actions
    document.addEventListener('click', (e) => {
      if (e.target.matches('a[href*="mailto:"]')) {
        e.preventDefault();
        this.showActionPaywall('email', '📧', 'Email Article', 'Share this article via email', 75, 1);
      }
      
      if (e.target.matches('.bookmark-btn, [data-action="bookmark"]')) {
        e.preventDefault();
        this.showActionPaywall('bookmark', '🔖', 'Bookmark Article', 'Save this article for later reading', 25, 1);
      }
      
      if (e.target.matches('.comment-btn, [data-action="comment"]')) {
        e.preventDefault();
        this.showActionPaywall('comment', '💬', 'Leave Comment', 'Express your thoughts and engage with the community', 50, 2);
      }
      
      if (e.target.matches('.print-btn, [data-action="print"]')) {
        e.preventDefault();
        this.showActionPaywall('print', '🖨️', 'Print Article', 'Generate a printer-friendly version', 150, 1);
      }
    });
    
    // Override right-click for context menu
    document.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      this.showActionPaywall('context', '📋', 'Context Menu', 'Access advanced page options', 30, 1);
    });
  }
  
  showActionPaywall(action, icon, title, description, gemCost, energyCost) {
    // Check if user has enough for free action based on daily limits
    const maxActions = { comments: 3, bookmarks: 5, shares: 10 };
    const actionMap = { 
      comment: 'comments', 
      bookmark: 'bookmarks', 
      email: 'shares',
      print: 'shares',
      context: 'shares'
    };
    
    const limitType = actionMap[action] || 'shares';
    const used = this.dailyLimits[limitType] || 0;
    const max = maxActions[limitType] || 5;
    
    if (used >= max) {
      // Show paywall
      document.getElementById('paywallIcon').textContent = icon;
      document.getElementById('paywallAction').textContent = title;
      document.getElementById('paywallDescription').textContent = description;
      
      // Update cost displays
      const gemCostEl = document.querySelector('[data-cost-gems]');
      const energyCostEl = document.querySelector('[data-cost-energy]');
      
      if (gemCostEl) {
        gemCostEl.dataset.costGems = gemCost;
        gemCostEl.querySelector('.cost-amount').textContent = gemCost;
      }
      
      if (energyCostEl) {
        energyCostEl.dataset.costEnergy = energyCost;
        energyCostEl.querySelector('.cost-amount').textContent = energyCost;
      }
      
      document.getElementById('actionPaywall').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      
      this.currentAction = { action, icon, title, description, gemCost, energyCost };
      
      // Track analytics
      if (window.trackGoal) {
        window.trackGoal('action_paywall_shown', {
          action: action,
          gems_cost: gemCost,
          energy_cost: energyCost
        });
      }
    } else {
      // Allow free action and increment counter
      this.executeAction(action);
      this.dailyLimits[limitType] = used + 1;
      this.saveDailyLimits();
      this.updateLimitBars();
    }
  }
  
  executeAction(action) {
    // Simulate action execution
    const actions = {
      comment: () => alert('💬 Comment posted! Thanks for engaging with the community.'),
      bookmark: () => alert('🔖 Article bookmarked! Find it in your saved articles.'),
      email: () => alert('📧 Email sharing dialog would open here.'),
      print: () => alert('🖨️ Print dialog would open here.'),
      context: () => alert('📋 Context menu would appear here.'),
    };
    
    if (actions[action]) {
      actions[action]();
    }
  }
  
  updateCurrencyDisplay() {
    document.getElementById('gemsCount').textContent = this.currencies.gems;
    document.getElementById('energyCount').textContent = this.currencies.energy;
    document.getElementById('tokensCount').textContent = this.currencies.tokens;
  }
  
  updateLimitBars() {
    const maxLimits = { comments: 3, bookmarks: 5, shares: 10 };
    
    Object.keys(maxLimits).forEach(type => {
      const used = this.dailyLimits[type] || 0;
      const max = maxLimits[type];
      const percentage = (used / max) * 100;
      
      const progressEl = document.querySelector(`[data-used="${used}"][data-max="${max}"]`);
      if (progressEl) {
        progressEl.style.width = percentage + '%';
        progressEl.parentNode.querySelector('.limit-text').textContent = `${used}/${max} used`;
        
        if (percentage >= 100) {
          progressEl.style.background = 'linear-gradient(90deg, #d63031, #e17055)';
        }
      }
    });
  }
  
  updateSpendingDisplay() {
    const monthlyEl = document.getElementById('monthlySpending');
    const totalEl = document.getElementById('totalSpending');
    const savingsEl = document.getElementById('savingsVsPremium');
    
    if (monthlyEl) monthlyEl.textContent = `$${this.spending.monthly.toFixed(2)}`;
    if (totalEl) totalEl.textContent = `$${this.spending.total.toFixed(2)}`;
    if (savingsEl) {
      const savings = 12.99 - this.spending.monthly;
      savingsEl.textContent = `${savings >= 0 ? '+' : ''}$${savings.toFixed(2)}`;
      savingsEl.className = `stat-value ${savings >= 0 ? 'savings positive' : 'savings'}`;
    }
  }
  
  saveDailyLimits() {
    localStorage.setItem('dailyLimitsUsed', JSON.stringify(this.dailyLimits));
  }
  
  saveCurrencies() {
    Object.keys(this.currencies).forEach(currency => {
      localStorage.setItem(currency, this.currencies[currency]);
    });
  }
  
  saveSpending() {
    localStorage.setItem('monthlySpending', this.spending.monthly);
    localStorage.setItem('totalSpending', this.spending.total);
  }
  
  startEnergyRegeneration() {
    // Regenerate 1 energy every 30 minutes (for demo: every 30 seconds)
    setInterval(() => {
      if (this.currencies.energy < 10) {
        this.currencies.energy++;
        this.saveCurrencies();
        this.updateCurrencyDisplay();
        
        const energyEl = document.getElementById('energyCount');
        energyEl.classList.add('currency-gain');
        setTimeout(() => energyEl.classList.remove('currency-gain'), 800);
      }
    }, 30000);
  }
  
  startLimitResetTimer() {
    const updateTimer = () => {
      const now = new Date();
      const tomorrow = new Date(now);
      tomorrow.setDate(tomorrow.getDate() + 1);
      tomorrow.setHours(0, 0, 0, 0);
      
      const diff = tomorrow - now;
      const hours = Math.floor(diff / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((diff % (1000 * 60)) / 1000);
      
      const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      
      const timerEl = document.getElementById('limitResetTimer');
      if (timerEl) {
        timerEl.textContent = timeString;
      }
    };
    
    updateTimer();
    setInterval(updateTimer, 1000);
  }
}

function showCurrencyStore() {
  document.getElementById('currencyStore').classList.remove('hidden');
  document.body.style.overflow = 'hidden';
  
  if (window.trackGoal) {
    window.trackGoal('currency_store_opened', {});
  }
}

function closeCurrencyStore() {
  document.getElementById('currencyStore').classList.add('hidden');
  document.body.style.overflow = '';
}

function closeActionPaywall() {
  document.getElementById('actionPaywall').classList.add('hidden');
  document.body.style.overflow = '';
}

function payWithCurrency(currency, amount) {
  const system = window.microtransactionSystem;
  
  if (system.currencies[currency] >= amount) {
    system.currencies[currency] -= amount;
    system.saveCurrencies();
    system.updateCurrencyDisplay();
    
    // Execute the action
    if (system.currentAction) {
      system.executeAction(system.currentAction.action);
    }
    
    closeActionPaywall();
    
    // Animate currency loss
    const currencyEl = document.getElementById(currency + 'Count');
    currencyEl.classList.add('currency-loss');
    setTimeout(() => currencyEl.classList.remove('currency-loss'), 600);
    
    if (window.trackGoal) {
      window.trackGoal('currency_payment', {
        currency: currency,
        amount: amount,
        action: system.currentAction?.action
      });
    }
  } else {
    alert(`💎 Not enough ${currency}! You need ${amount} but only have ${system.currencies[currency]}.`);
    showCurrencyStore();
  }
}

function payWithMoney(amount) {
  const system = window.microtransactionSystem;
  
  // Track spending
  system.spending.monthly += amount;
  system.spending.total += amount;
  system.saveSpending();
  system.updateSpendingDisplay();
  
  // Execute the action
  if (system.currentAction) {
    system.executeAction(system.currentAction.action);
  }
  
  closeActionPaywall();
  
  alert(`💳 Payment of $${amount.toFixed(2)} processed! Action completed.`);
  
  if (window.trackGoal) {
    window.trackGoal('money_payment', {
      amount: amount,
      action: system.currentAction?.action
    });
  }
}

function purchaseGems(amount, price) {
  const system = window.microtransactionSystem;
  
  system.currencies.gems += amount;
  system.spending.monthly += price;
  system.spending.total += price;
  
  system.saveCurrencies();
  system.saveSpending();
  system.updateCurrencyDisplay();
  system.updateSpendingDisplay();
  
  closeCurrencyStore();
  
  alert(`💎 Purchased ${amount} gems for $${price.toFixed(2)}!`);
  
  if (window.trackGoal) {
    window.trackGoal('gems_purchased', {
      amount: amount,
      price: price
    });
  }
}

function purchaseEnergy(amount) {
  const system = window.microtransactionSystem;
  const gemCost = amount === 5 ? 100 : 150;
  
  if (system.currencies.gems >= gemCost) {
    system.currencies.gems -= gemCost;
    system.currencies.energy = Math.min(10, system.currencies.energy + amount);
    
    system.saveCurrencies();
    system.updateCurrencyDisplay();
    
    alert(`⚡ Purchased ${amount} energy for ${gemCost} gems!`);
    
    if (window.trackGoal) {
      window.trackGoal('energy_purchased', {
        amount: amount,
        gem_cost: gemCost
      });
    }
  } else {
    alert(`💎 Not enough gems! You need ${gemCost} gems.`);
  }
}

function selectSubscription(tier) {
  if (window.trackGoal) {
    window.trackGoal('subscription_selected', {
      tier: tier,
      price: tier === 'basic' ? 4.99 : 12.99
    });
  }
  
  window.location.href = `/subscribe/?tier=microtransactions-${tier}&feature=unlimited-actions`;
}

function watchAdForCurrency() {
  // Simulate ad watching
  const adModal = document.createElement('div');
  adModal.innerHTML = `
    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10001; display: flex; align-items: center; justify-content: center;">
      <div style="background: white; padding: 30px; border-radius: 16px; text-align: center; max-width: 400px;">
        <h3>📺 Sponsored Advertisement</h3>
        <div style="background: #6c5ce7; height: 200px; display: flex; align-items: center; justify-content: center; margin: 20px 0; border-radius: 12px; color: white;">
          <p style="font-size: 18px;">💎 Gem Store Ad</p>
        </div>
        <div>Watch time: <span id="adTimer">30</span> seconds</div>
        <p style="font-size: 12px; color: #666; margin-top: 10px;">Earn gems by watching ads</p>
      </div>
    </div>
  `;
  
  document.body.appendChild(adModal);
  
  let countdown = 30;
  const timer = setInterval(() => {
    countdown--;
    document.getElementById('adTimer').textContent = countdown;
    
    if (countdown <= 0) {
      clearInterval(timer);
      document.body.removeChild(adModal);
      
      // Grant gems
      const system = window.microtransactionSystem;
      system.currencies.gems += 25;
      system.saveCurrencies();
      system.updateCurrencyDisplay();
      
      alert('🎉 Ad complete! You earned 25 gems!');
      closeActionPaywall();
    }
  }, 1000);
  
  if (window.trackGoal) {
    window.trackGoal('ad_watched_for_currency', {});
  }
}

function takeSurveyForCurrency() {
  alert('📋 Survey completed! You earned 100 gems!');
  
  const system = window.microtransactionSystem;
  system.currencies.gems += 100;
  system.saveCurrencies();
  system.updateCurrencyDisplay();
  
  closeActionPaywall();
  
  if (window.trackGoal) {
    window.trackGoal('survey_completed_for_currency', {});
  }
}

function shareForCurrency() {
  const shareText = `💎 I just discovered how micro-transactions monetize every action on EVIL1.ORG! Check out their comprehensive dark pattern demos: ${window.location.href}`;
  
  if (navigator.share) {
    navigator.share({
      title: 'EVIL1.ORG - Micro-transaction Demo',
      text: shareText,
      url: window.location.href
    }).then(() => {
      const system = window.microtransactionSystem;
      system.currencies.gems += 50;
      system.saveCurrencies();
      system.updateCurrencyDisplay();
      
      alert('🎉 Thanks for sharing! You earned 50 gems!');
      closeActionPaywall();
    });
  } else {
    navigator.clipboard.writeText(shareText).then(() => {
      const system = window.microtransactionSystem;
      system.currencies.gems += 50;
      system.saveCurrencies();
      system.updateCurrencyDisplay();
      
      alert('🎉 Share text copied! You earned 50 gems!');
      closeActionPaywall();
    });
  }
  
  if (window.trackGoal) {
    window.trackGoal('shared_for_currency', {});
  }
}

// Initialize micro-transaction system when page loads
document.addEventListener('DOMContentLoaded', function() {
  window.microtransactionSystem = new MicrotransactionSystem();
});
</script>